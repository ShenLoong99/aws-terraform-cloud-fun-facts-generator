name: "Production Deployment"
on:
  workflow_dispatch: # Allows manual trigger after you approve TFC

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        # Add this step back to install the terraform command
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_wrapper: false # Recommended for cleaner script output

      - name: Get Region from Terraform
        id: get_region
        run: |
          # Uses awk to find the variable block and extract the default value regardless of spacing
          REGION=$(awk '/variable "aws_region"/, /}/' variables.tf | grep "default" | cut -d'"' -f2 | tr -d '[:space:]')
          
          if [ -z "$REGION" ]; then
            echo "❌ Error: Could not find default aws_region in variables.tf"
            exit 1
          fi
          
          echo "AWS_REGION=$REGION" >> $GITHUB_ENV
          echo "Detected Region: $REGION"

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::871308866502:role/GitHubActionRole
          aws-region: ${{ env.AWS_REGION }}

      # We SKIP terraform init/apply here because TFC is already doing it!
      
      - name: Find Resources
        id: vars
        run: |
          # Get all buckets and find the one with the correct Project tag
          ALL_BUCKETS=$(aws s3api list-buckets --query "Buckets[].Name" --output text)
          
          for bucket in $ALL_BUCKETS; do
            # Get the tag value and remove any potential quotes
            TAG_VALUE=$(aws s3api get-bucket-tagging --bucket "$bucket" --query "TagSet[?Key=='Project'].Value" --output text 2>/dev/null | tr -d '"' | xargs)
            
            if [ "$TAG_VALUE" == "CloudFunFacts" ]; then
              FINAL_BUCKET="$bucket"
              break
            fi
          done

          # Find CloudFront ID and clean the output
          RAW_DIST_ID=$(aws cloudfront list-distributions --query "DistributionList.Items[?contains(Comment, 'CloudFunFacts')].Id" --output text)
          FINAL_DIST_ID=$(echo "$RAW_DIST_ID" | tr -d '"' | xargs)
          
          # Safety check: prevent empty variables from being written
          if [ -n "$FINAL_BUCKET" ]; then
            echo "BUCKET_NAME=$FINAL_BUCKET" >> $GITHUB_ENV
          fi
          
          if [ -n "$FINAL_DIST_ID" ] && [ "$FINAL_DIST_ID" != "None" ]; then
            echo "DIST_ID=$FINAL_DIST_ID" >> $GITHUB_ENV
          fi

          echo "✅ Found Bucket: $FINAL_BUCKET"
          echo "✅ Found Distribution: $FINAL_DIST_ID"

      - name: Deploy Frontend to S3
        run: aws s3 sync ./frontend/ s3://${{ env.BUCKET_NAME }} --delete

      - name: Invalidate CloudFront Cache
        run: aws cloudfront create-invalidation --distribution-id ${{ env.DIST_ID }} --paths "/*"

      - name: Run Deployment Health Check
        run: |
          chmod +x ./health-check.sh
          ./health-check.sh