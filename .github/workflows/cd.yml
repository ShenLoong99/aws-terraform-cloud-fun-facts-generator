name: "Production Deployment"
on:
  workflow_dispatch: # Allows manual trigger after you approve TFC

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        # Add this step back to install the terraform command
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_wrapper: false # Recommended for cleaner script output

      - name: Get Region from Terraform
        id: get_region
        run: |
          # Uses awk to find the variable block and extract the default value regardless of spacing
          REGION=$(awk '/variable "aws_region"/, /}/' variables.tf | grep "default" | cut -d'"' -f2 | tr -d '[:space:]')
          
          if [ -z "$REGION" ]; then
            echo "❌ Error: Could not find default aws_region in variables.tf"
            exit 1
          fi
          
          echo "AWS_REGION=$REGION" >> $GITHUB_ENV
          echo "Detected Region: $REGION"

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::871308866502:role/GitHubActionRole
          aws-region: ${{ env.AWS_REGION }}

      # We SKIP terraform init/apply here because TFC is already doing it!
      
      - name: Wait for Terraform Cloud & Get Outputs
        id: vars
        run: |
          # 1. Find S3 Bucket by Tag
          ALL_BUCKETS=$(aws s3api list-buckets --query "Buckets[].Name" --output text)
          for bucket in $ALL_BUCKETS; do
            TAG_VAL=$(aws s3api get-bucket-tagging --bucket "$bucket" --query "TagSet[?Key=='Project'].Value" --output text 2>/dev/null || echo "None")
            if [ "$TAG_VAL" == "CloudFunFacts" ]; then
              echo "BUCKET_NAME=$bucket" >> $GITHUB_ENV
              echo "✅ Found Bucket: $bucket"
              break
            fi
          done

          # 2. Find CloudFront Distribution by Tag
          # We list ARNs and then check tags for each to find the match
          DIST_ARNS=$(aws cloudfront list-distributions --query "DistributionList.Items[].ARN" --output text)
          for arn in $DIST_ARNS; do
            TAG_MATCH=$(aws cloudfront list-tags-for-resource --resource "$arn" --query "Tags.Items[?Key=='Project' && Value=='CloudFunFacts'].Value" --output text)
            if [ "$TAG_MATCH" == "CloudFunFacts" ]; then
              # Extract ID from ARN (the part after the last slash)
              ID=$(echo $arn | rev | cut -d'/' -f1 | rev)
              echo "DIST_ID=$ID" >> $GITHUB_ENV
              echo "✅ Found Distribution: $ID"
              break
            fi
          done

      - name: Deploy Frontend to S3
        run: aws s3 sync ./frontend/ s3://${{ env.BUCKET_NAME }} --delete

      - name: Invalidate CloudFront Cache
        run: aws cloudfront create-invalidation --distribution-id ${{ env.DIST_ID }} --paths "/*"

      - name: Run Deployment Health Check
        run: |
          chmod +x ./scripts/health-check.sh
          ./scripts/health-check.sh
        env:
          AWS_REGION: ${{ env.AWS_REGION }}